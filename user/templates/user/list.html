{% extends "_dash_base.html" %}
{% load static %}
{% load common_tags %}
{% block title %}
   User List
{% endblock title %}
{% block content %}
   <div class="card">
      <div class="px-6 pt-6">
         <!-- Display messages -->
         {% if messages %}
            {% for message in messages %}
               <div class="alert alert-{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}danger{% else %}secondary{% endif %} alert-dismissible mb-4">
                  {{ message }}
                  <button class="btn-close"></button>
               </div>
            {% endfor %}
         {% endif %}
         <!-- End Display messages -->
         <div class="d-flex align-items-center justify-content-between">
            <h5>User List</h5>
            <div class="d-flex align-items-center justify-content-between gap-2">
               <a href="{% url 'user_add' %}" class="btn btn-primary">
                  <div class="d-flex align-items-center justify-content-between gap-1">
                     <i class="bx bx-plus fs-4"></i>
                     <span>Add User</span>
                  </div>
               </a>
               <div class="dropdown">
                  <div class="dropdown-toggle text-body cursor-pointer">
                     <i class="bx bx-dots-vertical-rounded fs-4"></i>
                  </div>
                  <div class="dropdown-menu dropdown-menu-end">
                     <div class="px-6 pt-2 pb-3 mb-1 border-bottom">Export</div>
                     <a href="{% url "user_list_export_as_xlsx" %}?status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&q={{ request.GET.q|default:'' }}"
                        class="dropdown-item">
                        <div class="d-flex align-items-center gap-2">
                           <i class="bx bx-table fs-4"></i>
                           <span>xlsx</span>
                        </div>
                     </a>
                     <a href="{% url "user_list_export_as_csv" %}?status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&q={{ request.GET.q|default:'' }}"
                        class="dropdown-item">
                        <div class="d-flex align-items-center gap-2">
                           <i class="bx bx-file fs-4"></i>
                           <span>csv</span>
                        </div>
                     </a>
                     <a href="{% url "user_list_print" %}?status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&q={{ request.GET.q|default:'' }}"
                        class="dropdown-item"
                        target="_blank">
                        <div class="d-flex align-items-center gap-2">
                           <i class="bx bx-printer fs-4"></i>
                           <span>Print</span>
                        </div>
                     </a>
                     <a href="{% url "user_list_copy" %}?status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&q={{ request.GET.q|default:'' }}"
                        class="dropdown-item"
                        target="_blank">
                        <div class="d-flex align-items-center gap-2">
                           <i class="bx bx-copy fs-4"></i>
                           <span>Copy</span>
                        </div>
                     </a>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="row g-4 px-6 my-4">
         <div class="col-12 col-sm-6">
            <form method="get">
               <select class="form-select"
                       name="status"
                       id="status"
                       onchange="this.form.submit()">
                  {% for key, value in status_options.items %}
                     <option value="{{ value }}"
                             {% if request.GET.status == value %}selected{% endif %}>{{ key }}</option>
                  {% endfor %}
               </select>
               <input type="hidden" name="page_size" value="{{ current_page_size }}">
               <input type="hidden" name="role" value="{{ request.GET.role|default:'' }}">
               <input type="hidden" name="q" value="{{ request.GET.q|default:'' }}">
            </form>
         </div>
         <div class="col-12 col-sm-6">
            <form method="get">
               <select class="form-select"
                       name="role"
                       id="role"
                       onchange="this.form.submit()">
                  {% for key, value in role_options.items %}
                     <option value="{{ value }}"
                             {% if request.GET.role == value %}selected{% endif %}>{{ key }}</option>
                  {% endfor %}
               </select>
               <input type="hidden" name="page_size" value="{{ current_page_size }}">
               <input type="hidden"
                      name="status"
                      value="{{ request.GET.status|default:'' }}">
               <input type="hidden" name="q" value="{{ request.GET.q|default:'' }}">
            </form>
         </div>
         <div class="col-12 col-sm-6">
            <form method="get">
               <select class="form-select"
                       name="page_size"
                       id="pageSize"
                       onchange="this.form.submit()">
                  {% for size in page_size_options %}
                     <option value="{{ size }}"
                             {% if current_page_size == size %}selected{% endif %}>{{ size }}</option>
                  {% endfor %}
               </select>
               <input type="hidden"
                      name="status"
                      value="{{ request.GET.status|default:'' }}">
               <input type="hidden" name="role" value="{{ request.GET.role|default:'' }}">
               <input type="hidden" name="q" value="{{ request.GET.q|default:'' }}">
            </form>
         </div>
         <div class="col-12 col-sm-6">
            <form method="get" id="formSearchFormUsers">
               <div class="search-close-wrapper">
                  <input type="search"
                         placeholder="Search from Users"
                         class="form-control search-input"
                         name="q"
                         id="inputSeachFromUsers"
                         value="{{ request.GET.q|default:'' }}">
                  <i class="bx bx-x bx-sm search-closer cursor-pointer"
                     onclick="document.getElementById('inputSeachFromUsers').value=''; document.getElementById('formSearchFormUsers').submit();"></i>
               </div>
               <input type="hidden" name="page_size" value="{{ current_page_size }}">
               <input type="hidden"
                      name="status"
                      value="{{ request.GET.status|default:'' }}">
               <input type="hidden" name="role" value="{{ request.GET.role|default:'' }}">
            </form>
         </div>
      </div>
      <div class="mb-5">
         <table class="dash-table user">
            <thead>
               <tr>
                  <th>User</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Actions</th>
                  <th>Actions</th>
               </tr>
            </thead>
            <tbody>
               {% for userobj in users %}
                  <tr>
                     <td>
                        <a href="{% url 'user_view' userobj.id %}"
                           class="text-heading-link text-truncate">
                           <div class="d-flex">
                              <div class="me-3">{% include "user/includes/_avatar.html" with userobj=userobj %}</div>
                              <div>
                                 <p class="fs-4 mb-0">{{ userobj.profile.full_name }}</p>
                                 <small class="text-muted">{{ userobj.email }}</small>
                              </div>
                           </div>
                        </a>
                     </td>
                     <td>
                        <div class="d-flex align-items-center gap-2">{% include "user/includes/_role.html" with html=True %}</div>
                     </td>
                     <td>
                        {% if userobj.is_active %}
                           <span class="badge bg-label-success rounded fw-500">Active</span>
                        {% else %}
                           <span class="badge bg-label-danger rounded fw-500">Disabled</span>
                        {% endif %}
                     </td>
                     <td>
                        <div class="d-flex align-items-center gap-1">
                           <a href="{% url 'user_edit' userobj.id %}" class="text-heading-link">
                              <i class="bx bx-edit fs-5"></i>
                           </a>
                           <a href="{% url 'user_delete' userobj.id %}" class="text-heading-link">
                              <i class="bx bx-trash fs-5"></i>
                           </a>
                        </div>
                     </td>
                     <td>
                        <div class="dropdown">
                           <a href="#" class="dropdown-toggle text-body">
                              <i class="bx bx-dots-vertical-rounded fs-4"></i>
                           </a>
                           <div class="dropdown-menu dropdown-menu-end">
                              <a href="{% url 'user_edit' userobj.id %}" class="dropdown-item">
                                 <div class="d-flex align-items-center gap-2">
                                    <i class="bx bx-edit fs-4"></i>
                                    <span>Edit</span>
                                 </div>
                              </a>
                              <a href="{% url 'user_delete' userobj.id %}" class="dropdown-item">
                                 <div class="d-flex align-items-center gap-2">
                                    <i class="bx bx-trash fs-4"></i>
                                    <span>Delete</span>
                                 </div>
                              </a>
                           </div>
                        </div>
                     </td>
                  </tr>
               {% endfor %}
            </tbody>
         </table>
      </div>
      <!-- Pagination -->
      {% if is_paginated %}
         <div class="row px-6 mb-5">
            <div class="col-sm-12 col-lg-6">
               <div class="dash-table-pagination-info text-muted">
                  Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} Items
               </div>
            </div>
            <div class="col-sm-12 col-lg-6">
               <div class="dash-table-pagination-container">
                  <ul class="pagination">
                     {% if page_obj.has_previous %}
                        <li class="page-item page-item-first">
                           <a href="?page=1&status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&page_size={{ current_page_size }}&q={{ request.GET.q|default:'' }}"
                              class="page-link">
                              <i class="bx bx-first-page bx-18px"></i>
                           </a>
                        </li>
                        <li class="page-item page-item-previous">
                           <a href="?page={{ page_obj.previous_page_number }}&status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&page_size={{ current_page_size }}&q={{ request.GET.q|default:'' }}"
                              class="page-link">
                              <i class="bx bx-chevron-left bx-18px"></i>
                           </a>
                        </li>
                     {% else %}
                        <li class="page-item page-item-first disabled">
                           <a href="#" class="page-link">
                              <i class="bx bx-first-page bx-18px"></i>
                           </a>
                        </li>
                        <li class="page-item page-item-previous disabled">
                           <a href="#" class="page-link">
                              <i class="bx bx-chevron-left bx-18px"></i>
                           </a>
                        </li>
                     {% endif %}
                     {% if page_obj.paginator.num_pages > 4 %}
                        {% for i in page_obj.paginator.page_range %}
                           {% if i == page_obj.number %}
                              <li class="page-item {% if i == page_obj.number %}active{% endif %}">
                                 <a href="?page={{ i }}&status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&page_size={{ current_page_size }}&q={{ request.GET.q|default:'' }}"
                                    class="page-link">{{ i }}</a>
                              </li>
                           {% elif i == page_obj.number|add:'-3' or i == page_obj.number|add:'3' %}
                              <li class="page-item">
                                 <a href="?page={{ i }}&status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&page_size={{ current_page_size }}&q={{ request.GET.q|default:'' }}"
                                    class="page-link"><i class="bx bx-dots-horizontal-rounded"></i></a>
                              </li>
                           {% endif %}
                        {% endfor %}
                     {% else %}
                        {% for i in page_obj.paginator.page_range %}
                           <li class="page-item {% if i == page_obj.number %}active{% endif %}">
                              <a href="?page={{ i }}&status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&page_size={{ current_page_size }}&q={{ request.GET.q|default:'' }}"
                                 class="page-link">{{ i }}</a>
                           </li>
                        {% endfor %}
                     {% endif %}
                     {% if page_obj.has_next %}
                        <li class="page-item page-item-next">
                           <a href="?page={{ page_obj.next_page_number }}&status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&page_size={{ current_page_size }}&q={{ request.GET.q|default:'' }}"
                              class="page-link">
                              <i class="bx bx-chevron-right bx-18px"></i>
                           </a>
                        </li>
                        <li class="page-item page-item-last">
                           <a href="?page={{ page_obj.paginator.num_pages }}&status={{ request.GET.status|default:'' }}&role={{ request.GET.role|default:'' }}&page_size={{ current_page_size }}&q={{ request.GET.q|default:'' }}"
                              class="page-link">
                              <i class="bx bx-last-page bx-18px"></i>
                           </a>
                        </li>
                     {% else %}
                        <li class="page-item page-item-next disabled">
                           <a href="#" class="page-link">
                              <i class="bx bx-chevron-right bx-18px"></i>
                           </a>
                        </li>
                        <li class="page-item page-item-last disabled">
                           <a href="#" class="page-link">
                              <i class="bx bx-last-page bx-18px"></i>
                           </a>
                        </li>
                     {% endif %}
                  </ul>
               </div>
            </div>
         </div>
      {% endif %}
   </div>
{% endblock content %}
